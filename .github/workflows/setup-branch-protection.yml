name: Setup Branch Protection

# This workflow can be manually triggered to configure branch protection rules
# It requires a BRANCH_PROTECTION_TOKEN secret with 'repo' scope

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to protect'
        required: true
        default: 'main'
        type: string

permissions:
  contents: read

jobs:
  configure-protection:
    name: Configure Branch Protection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate branch exists
        env:
          BRANCH: ${{ inputs.branch }}
        run: |
          # Validate branch name format to prevent command injection
          # Check for dangerous shell metacharacters as defense-in-depth
          if echo "$BRANCH" | grep -qE '[$`;|&<>(){}]'; then
            echo "✗ Invalid branch name: contains shell metacharacters"
            echo "Branch name: '$BRANCH'"
            exit 1
          fi
          
          # Validate using Git's reference format rules
          if ! git check-ref-format --branch "$BRANCH" >/dev/null 2>&1; then
            echo "✗ Invalid branch name format: '$BRANCH'"
            echo "Branch names must follow Git reference naming rules"
            exit 1
          fi
          
          git fetch origin
          # Check if the validated branch exists in the remote repository
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            echo "✓ Branch '$BRANCH' exists"
          else
            echo "✗ Branch '$BRANCH' does not exist"
            exit 1
          fi

      - name: Configure branch protection
        env:
          GITHUB_TOKEN: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          BRANCH: ${{ inputs.branch }}
        run: |
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "❌ Error: BRANCH_PROTECTION_TOKEN secret is not configured"
            echo ""
            echo "To set it up:"
            echo "1. Create a Personal Access Token with 'repo' scope"
            echo "2. Go to repository Settings > Secrets and variables > Actions"
            echo "3. Create a new secret named 'BRANCH_PROTECTION_TOKEN'"
            exit 1
          fi

          # The script provides comprehensive output including success/failure status
          ./.github/scripts/setup-branch-protection.sh
