name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Size Check
        run: |
          # Count changed files and lines
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{added+=$1} END {print added}')
          DELETED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{deleted+=$2} END {print deleted}')
          TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))

          echo "## ðŸ“Š PR Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Changed:** $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines Added:** $ADDED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Lines Deleted:** $DELETED_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Changes:** $TOTAL_CHANGES" >> $GITHUB_STEP_SUMMARY

          # Warn if PR is too large
          if [ $TOTAL_CHANGES -gt 1000 ]; then
            echo "âš ï¸ **Warning:** This PR is quite large ($TOTAL_CHANGES lines changed). Consider breaking it into smaller PRs for easier review." >> $GITHUB_STEP_SUMMARY
          elif [ $TOTAL_CHANGES -gt 500 ]; then
            echo "âš ï¸ **Note:** This PR is moderately sized ($TOTAL_CHANGES lines changed)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Good:** This PR is reasonably sized ($TOTAL_CHANGES lines changed)." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check PR Title Format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"

          # Check if title follows conventional commit format
          if echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+'; then
            echo "âœ… PR title follows conventional commit format" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ PR title doesn't follow conventional commit format. Consider using: type(scope): description" >> $GITHUB_STEP_SUMMARY
            echo "Examples: feat(hero): add animations, fix(a11y): improve keyboard navigation" >> $GITHUB_STEP_SUMMARY
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: on-failure

  bundle-size-check:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze bundle
        run: |
          npm run build

          # Get dist folder size
          DIST_SIZE=$(du -sh dist | cut -f1)
          echo "## ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Dist Size:** $DIST_SIZE" >> $GITHUB_STEP_SUMMARY

          # List largest files
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Largest Files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          du -sh dist/assets/* | sort -rh | head -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Performance Budget Check
        run: |
          # Check if any JS bundle exceeds 200KB (performance budget)
          LARGE_FILES=$(find dist/assets -name "*.js" -size +200k)

          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ **Warning:** Some JS bundles exceed 200KB performance budget:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$LARGE_FILES" | xargs ls -lh >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All JS bundles are within the 200KB performance budget" >> $GITHUB_STEP_SUMMARY
          fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [pr-metadata, bundle-size-check]
    if: always()

    steps:
      - name: Generate Quality Report
        run: |
          echo "## ðŸŽ¯ PR Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status Checks" >> $GITHUB_STEP_SUMMARY
          echo "- PR Metadata: ${{ needs.pr-metadata.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle Size: ${{ needs.bundle-size-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All quality checks must pass before merging." >> $GITHUB_STEP_SUMMARY
