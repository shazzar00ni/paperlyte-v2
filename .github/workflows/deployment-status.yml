name: Deployment Status

on:
  deployment_status:

jobs:
  notify-deployment:
    name: Deployment Notification
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    if: github.event.deployment_status.state != 'pending'

    steps:
      - name: Deployment Status Check
        run: |
          echo "Deployment Status: ${{ github.event.deployment_status.state }}"
          echo "Environment: ${{ github.event.deployment_status.environment }}"
          echo "Target URL: ${{ github.event.deployment_status.target_url }}"

          if [ "${{ github.event.deployment_status.state }}" = "success" ]; then
            echo "âœ… Deployment succeeded!"
            echo "ðŸŒ Site URL: ${{ github.event.deployment_status.target_url }}"
          elif [ "${{ github.event.deployment_status.state }}" = "failure" ]; then
            echo "âŒ Deployment failed!"
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.deployment_status.environment }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.deployment_status.state }}" = "success" ]; then
            echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            echo "| Preview URL | [${{ github.event.deployment_status.target_url }}](${{ github.event.deployment_status.target_url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.deployment_status.state }}" = "failure" ]; then
            echo "| Status | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | ${{ github.event.deployment_status.state }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR (if applicable)
        if: github.event.deployment_status.state == 'success' && github.event.deployment.payload.pull_request != null
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.deployment.payload.pull_request?.number;
            if (!prNumber) {
              core.info('No PR number found in deployment payload');
              return;
            }
            const targetUrl = context.payload.deployment_status.target_url;
            const environment = context.payload.deployment_status.environment;

            const comment = `## ðŸš€ Deployment Successful

            **Environment:** ${environment}
            **Preview URL:** ${targetUrl}

            Your changes have been deployed and are ready for review!`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
